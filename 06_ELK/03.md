# EUR 
GET kibana_sample_data_ecommerce/_search
{
  "size": 0, // 결과 중에 n개만 보여주는 역할 
  "query": {
    "term": {
      "currency": {
        "value": "EUR"
      }
    }
  },
  "aggs": {
    "my-sum-aggregation-name": {
      "sum": {
        "field": "taxless_total_price"
      }
    }
  }
}

// syntax 에러 말고는 딱히 에러가 없어요
# noop -> no operation: 아까 한 작업을 또 하게 할 때는 굳이 모든 것을 변경하는 수고를 감내하지 않겠다는 의미.
GET kibana_sample_data_ecommerce/_search
{
  "size": 0, // 검색 결과를 생략
  "query": {
    "match": {  
      "currency": "EUR"
    }
  }, // 조건에 맞는 DOC를 검색,
  "aggs": {
    "EUR로 결제한 총 금액": {  // 집계 결과를 어떤 이름으로 부를지
      "sum": { // 어떤 집계를 수행할 것인지,
        "field": "products.taxful_price" 
      }
    }
  }
}

GET kibana_sample_data_ecommerce/_search
// Africa에서 일어난 매출은 총 얼마인지?
GET kibana_sample_data_ecommerce/_search
{
  "size": 0, // 검색 결과를 생략
  "query": {
    "match": {  
      "geoip.continent_name": "Africa"
    }
  }, // 조건에 맞는 DOC를 검색,
  "aggs": {
    "아프리카에서 결제한 금액": {  // 집계 결과를 어떤 이름으로 부를지,,
      "extended_stats": { // stats 어떤 집계를 수행할 것인지,
        "field": "products.taxful_price" 
      }
    }
  }
}


# cardinality - 지정한 필드가 가진 고유한 값의 개수를 계산해 반환한다.
# HyperLogLog++ 알고리즘 을 사용해 추정한 근사값이다.
# 1. 지정된 threshold 기준으로 각 document을 해싱한다. (규격화된 난수를 만듬
# 2.앞의 n자리 정도만 겹치는 값들을 '같은 값'이라고 어림짐작합니다. 
# 3. 그 결과를 돌려주게 된다.
# 확실한 cardinality를 보장받는 방법 -> 전체 document의 수만큼 threshold를 줍니다. 
# 대용량분산처리 프레임워크에서 고유값을 찾으실 때는 나온 값 그대로를 믿지 마세요. 
GET kibana_sample_data_ecommerce/_search
{
  "size": 0, 
  "query": {
    "term": {
      "currency": {
        "value": "EUR"
      }
    }
  },
"aggs": {
    "my-cardinality-aggregation-name": {
      "cardinality": {
        "field": "customer_id",
        "precision_threshold": 2
      }
    }
  }
}


GET kibana_sample_data_ecommerce/_search
{
  "size": 0, 
  "query": {
    "term": {
      "currency": {
        "value": "EUR"
      }
    }
  },
"aggs": {
    "percentile result": {
      "percentiles": {
        "field": "taxful_total_price"
      }
    }
  }
}

GET kibana_sample_data_ecommerce/_search
{
  "size": 0, 
  "query": {
    "term": {
      "currency": {
        "value": "EUR"
      }
    }
  },
"aggs": {
    "percentile ranks result": {
      "percentile_ranks": {
        "field": "taxful_total_price",
        "values": [65, 20]
      }
    }
  }
}

DELETE bank

PUT _bulk
{"index":{"_index":"bank", "_id": "1"}}
{"date": "2018-06-01", "bank": "NH농협은행", "branch": "1호점", "location": "종각", "customers": 2314}
{"index":{"_index":"bank", "_id": "2"}}
{"date": "2017-06-01", "bank": "NH농협은행", "branch": "1호점", "location": "강남", "customers": 5412}
{"index":{"_index":"bank", "_id": "3"}}
{"date": "2017-07-10", "bank": "국민은행", "branch": "1호점", "location": "강남", "customers": 2543}
{"index":{"_index":"bank", "_id": "4"}}
{"date": "2018-07-15", "bank": "NH농협은행", "branch": "2호점", "location": "강남", "customers": 4456}
{"index":{"_index":"bank", "_id": "5"}}
{"date": "2019-08-07", "bank": "NH농협은행", "branch": "3호점", "location": "강남", "customers": 1562}
{"index":{"_index":"bank", "_id": "6"}}
{"date": "2020-08-18", "bank": "NH농협은행", "branch": "4호점", "location": "강남", "customers": 5724}
{"index":{"_index":"bank", "_id": "7"}}
{"date": "2020-09-02", "bank": "국민은행", "branch": "1호점", "location": "신촌", "customers": 1002}
{"index":{"_index":"bank", "_id": "8"}}
{"date": "2020-09-11", "bank": "국민은행", "branch": "1호점", "location": "양재", "customers": 4121}
{"index":{"_index":"bank", "_id": "9"}}
{"date": "2020-09-20", "bank": "NH농협은행", "branch": "3호점", "location": "홍제", "customers": 1021}
{"index":{"_index":"bank", "_id": "10"}}
{"date": "2020-10-01", "bank": "국민은행", "branch": "1호점", "location": "불광", "customers": 971}
{"index":{"_index":"bank", "_id": "11"}}
{"date": "2019-06-01", "bank": "NH농협은행", "branch": "2호점", "location": "종각", "customers": 875}
{"index":{"_index":"bank", "_id": "12"}}
{"date": "2018-06-01", "bank": "국민은행", "branch": "2호점", "location": "강남", "customers": 1506}
{"index":{"_index":"bank", "_id": "13"}}
{"date": "2020-09-02", "bank": "국민은행", "branch": "2호점", "location": "신촌", "customers": 3912}
{"index":{"_index":"bank", "_id": "14"}}
{"date": "2020-09-11", "bank": "국민은행", "branch": "2호점", "location": "양재", "customers": 784}
{"index":{"_index":"bank", "_id": "15"}}
{"date": "2020-10-01", "bank": "국민은행", "branch": "2호점", "location": "불광", "customers": 4513}
{"index":{"_index":"bank", "_id": "16"}}
{"date": "2020-10-01", "bank": "국민은행", "branch": "3호점", "location": "불광", "customers": 235}
{"index":{"_index":"bank", "_id": "17"}}
{"date": "2016-07-01", "bank": "기업은행", "branch": "1호점", "location": "불광", "customers": 971}
{"index":{"_index":"bank", "_id": "18"}}
{"date": "2017-10-01", "bank": "기업은행", "branch": "2호점", "location": "불광", "customers": 100}
{"index":{"_index":"bank", "_id": "19"}}
{"date": "2018-11-01", "bank": "기업은행", "branch": "3호점", "location": "불광", "customers": 151}
{"index":{"_index":"bank", "_id": "20"}}
{"date": "2020-10-01", "bank": "기업은행", "branch": "4호점", "location": "불광", "customers": 1302}

GET bank/_search
{
  "size":0,  //,
  "query": {
      // 검색,
  }, 
  "aggs": {   // 검색 결과를 바탕으로 집계
    "NAME": {
      "AGG_TYPE": {}
    }
  }
}

GET bank/_search

# 1. bank의 모든 고객수는 몇 명인가요?
GET bank/_search
{
  "size":0,  //,
  "aggs": {   // 검색 결과를 바탕으로 집계
    "고객수 총 합": {
      "sum": {
        "field": "customers"
      }
    }
  }
}

# 2. bank들 중에서 최소 고객을 보유한 은행의 고객 수는 몇 명인가요? 은행은 어디인지도 같이 적어주세요.
GET bank/_search
{
  "query": {
    "match_all": {}
  },
  "size": 0,
  "aggs": {
    "최소_고객_보유_은행": {
      "min": {
        "field": "customers"
      }
    }
  }
}

GET bank/_search
{
  "query": {
    "match": {
      "customers": 100
      }
  }
}

GET bank/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "bank": "desc", // 1차정렬
      "customers": "asc" //2차정렬 
    }
  ],
  "_source": ["bank", "branch", "customers"]

}


# 3. 불광지역에 있는 모든 은행들을 검색해보세요.
GET bank/_search
{
  "query": {
    "match": {
      "location": "불광"
      }
  }
}
# 4. 불광지역에 있는 모든 은행 고객수를 합하면 몇 명인가요?
GET bank/_search
{
  "query": {
    "match": {
      "location": "불광"
      }
  },
  "size": 0, 
  "aggs": {
    "불광 지역의 총 고객수": {
      "sum": {
        "field": "customers"
      }
    }
  }
}

# 집계 -> 해당 결과를 바탕으로 검색

# 1. 전체 은행 중에 방문고객이 상위 25% 이상인 은행들은 어디일까요? 
# 힌트: 범위(range)는 bool 쿼리 - must/must_not/should/filter 등의 API로 값을 검색
GET bank/_search
{
  "size": 0,
  "aggs": {
    "상위 25% 방문고객을 가진 은행": {
      "percentiles": {
        "field": "customers",
        "percents": [
          75
        ]
      }
    }
  }
}

GET bank/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "range": {
            "customers": {
              "gte": 3964.25
            }
          }
        }
      ]
    }
  },
  "sort": [
    {
      "customers": {
        "order": "desc"
      }
    }
  ]
}
# 2. 연 5000명 이상 방문하는 은행은 전체 점포 중 몇퍼센트 정도의 위치를 점하고 있을까요?
GET bank/_search
{
  "size": 0,
  "aggs": {
    "연 5000명 이상 방문하는 은행의 백분위": {
      "percentile_ranks": {
        "field": "customers",
        "values": [ 5000 ]
      }
    }
  }
}


# 2-1. 5000명 이상 방문하는 은행이 어느어느 은행인지도 찾아주세요. 
GET bank/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "range": {
            "customers": {
              "gte": 5000
            }
          }
        }
      ]
    }
  },
  "sort": [
    {
      "customers": {
        "order": "desc"
      }
    }
  ]
}

# 같은 depth 안에서 집계합수를 몇개라도 함께 전달 할 수 있습니다.
# 불광지역에 있는 가장 고객이 적은 은행 고객수, 가장 고객이 많은 은행 고객수를 같이 확인해 볼게요.
GET bank/_search
{
  "size": 0,
  "query": {
    "match": {
      "location": "불광"
    }
  },
  "aggs": {
    "가장 고객이 적은 은행": {
      "min": {
        "field": "customers"
      }
    },
    "가장 고객이 많은 은행": {
      "max": {
        "field": "customers"
      },
      "meta": { // 현재 집계에 대한 간략한 설명을 key - value로 작성해서 보낼 수 있습니다.
        "설명": "불광 지역에 대한 고객 정보"
      }
    }
  }
}

# 버킷 집계 - from : <= (이상 = 개구간)
#             to  :  <  (미만 = 폐구간)

// 버킷을 일정 구간이 아니라 임의로 나누어야 할 때는 우리가 일일히 버킷을 지정해줍니다.
GET kibana_sample_data_flights/_search
{
  "size": 0,
  "aggs": {
    "거리별-비행구간": {
      "range": {
        "field": "DistanceKilometers",
        "ranges": [ // 맨 첫 구간(to) 과 맨 마지막 구간(from) 은 
          {"to": 5000 },
          {"from": 5000,
            "to": 10000
          },
          {"from":10000,
          "to": 15000},
          {"from":15000}
        ]
      },
      "aggs": {
        "평균-비행기티켓가격": {
          "avg": {
            "field": "AvgTicketPrice"
          }
        }
      }
    }
  }
}

// 같은 간격으로 bucket을 만든다면 interval 이라는 파라미터로 구간의 크기를 지정할 수 있습니다.
// 0으로 떨어지지 않는 음수 구간을 설정할 때는 offset이라는 파라미터를 사용합니다.
GET kibana_sample_data_flights/_search
{
  "size": 0,
  "aggs": {
    "평균-비행기티켓가격": {
      "histogram": {
        "field": "DistanceKilometers",
        "interval": 5000,
        "offset": -50
      },
      "aggs": {
        "평균-비행기티켓가격": {
          "avg": {
            "field": "AvgTicketPrice"
          }
        }
      }
    }
  }
}

// 시간 구간은 calendar_interval 이라는 파라미터로 나눌 수 있습니다. 
// 1m - mimute 
// 1h - hour
// 1d - day
// 1M - month
// 1q - quarter (분기)
// 1y - year 

GET kibana_sample_data_flights/_search
{
  "size": 0,
  "aggs": {
    "일일 비행기 평균 금액": {
      "date_histogram": {
        "field": "timestamp",
        "fixed_interval": "1d"
      },
      "aggs": {
        "평균 비행기 금액": {
          "avg": {
            "field": "AvgTicketPrice"
          }
        }
      }
    }
  }
}

GET kibana_sample_data_flights/_search
{
  "size": 0,
  "aggs": {
    "일일 비행기 평균 금액": {
      "date_range": {
        "field": "timestamp",
        "ranges": [
          {"to": "now-2d/d"},
          {"from": "now-2d/d",
            "to": "now-1d/d"
          },
          {"from": "now-1d/d"
          }
          ]
      },
      "aggs": {
        "평균 비행기 금액": {
          "avg": {
            "field": "AvgTicketPrice"
          }
        }
      }
    }
  }
}

###
# terms 집계는 각 샤드에서 size 개수만큼 term을 뽑아 빈도수를 셉니다. 
# 버킷을 최대 몇 개까지 생성할 것인지를 size로 지정합니다.

GET kibana_sample_data_logs/_search
{
  "size": 0,
  "query": {
    "match_all": {}
},
"aggs": {
    "가장많이접속한 ip주소": {
      "terms": {
        "field": "host.keyword",
        "size": 1000
      }
    }
  }
}

GET kibana_sample_data_logs/_search
{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "composite-aggs": {
      "composite": {
        "size": 100, 
        "sources": [
          {
            "terms-aggs": {
              "terms": {
                "field": "host.keyword"
              }
            }
          },
          {
            "date-histogram-aggs": {
              "date_histogram": {
                "field": "@timestamp",
                "calendar_interval": "day", // unixtime을
                "format": "yyyy-MM-dd"
              }
            }
          }
        ]
      }
    }
  }
}


GET kibana_sample_data_logs/_search
{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "hosts": {
      "terms": {
        "field": "host.keyword"
      },
      "aggs": {
        "일자별집계": {
          "date_histogram": {
            "field": "@timestamp",
            "calendar_interval": "day",
            "format": "yyyy-MM-dd"
          }
        }
      }
    }
  }
}


GET kibana_sample_data_logs/_search
{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": { // 여러 필드를 조합 / 페이지네이션 after_key
    "composite-집계": {
      "composite": {
         "size": 10, // 조회 개수 
          "sources": [
          {
            "집계기준": {
              "terms": {
                "field": "host.keyword"
              }
            }
          },
                    {
            "일자별구간": {
              "date_histogram": {
                "field": "@timestamp",
                "calendar_interval": "day",
                "format": "yyyy-MM-dd"
              }
            }
          }
        ]
      }
    }
  }
}

GET kibana_sample_data_logs/_search
{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "composite집계": {
      "composite": {
        "size": 10, 
        "sources": [
          {
            "집계기준": {
              "terms": {
                "field": "host.keyword"
              }
            }
          },
          {
            "일자별구간": {
              "date_histogram": {
                "field": "@timestamp",
                "calendar_interval": "day",
                "format": "yyyy-MM-dd"
              }
            }
          }
        ],
        "after": {
          "집계기준": "artifacts.elastic.co",
          "일자별구간": "2024-09-02"
        }
      }
    }
  }
}


#### 파이프라인 집계 : 집계한 결과를 재집계
# 1년 동안 n권의 책을 사셨고, 가입후 지금까지 nn권을 사셨어요. 
GET kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "query": {
    "match_all": {}
  },
  "aggs": {
    "일자별구간": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "day",
        "format": "yyyy-MM-dd"
      },
      "aggs": {
        "일별누적판매개수": {
          "sum": {
            "field": "total_quantity"
          }
        },  
        "현재까지총누적판매개수": {
          "cumulative_sum": {
            "buckets_path": "일별누적판매개수"
          }
        }
      }
    }
  }
}

POST kibana_sample_data_ecommerce/_search
{
  "size": 0,
  "query": {
    "match_all": {}
  }, 
  "aggs": {
    "일자별구간": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "day",
        "format": "yyyy-MM-dd"
      },
      "aggs": {
        "일별평균판매개수": {
          "avg": {
            "field": "total_quantity"
          }
        }
      }
    },
    "가장많이판매된날의평균": {
      "max_bucket": {
        "buckets_path": "일자별구간>일별평균판매개수" 
      }
    }
  }
}





GET bank/_mapping
# customers 수가 100명 이상 152명 미만인 구간의 문서를 검색해보세요. 
# 집계함수 1. 검색 결과 전체의 메트릭 / 2. 결과 전체를 특정 구간으로 나누어서 해당 구간의 메트릭 / 3. 파이프라인 집계 - 집계 한 결과를 넘겨줘서 재집계  
GET bank/_search
{
  "size": 0,
  "aggs": {
    "customer수": {
      "range": {
        "field": "customers",
        "ranges": [
          // { "to": 150},
          {
            "from": 150,
            "to": 152
          }
          //, {"from": 152}
          ]
      },
      "aggs": {
        "고객수합": {
          "sum": {
            "field": "customers"
          }
        }
      }
    }
  }
}

# 500명 단위로 구간을 나누어서 숫자 범위로 문서를 검색해보세요.
GET bank/_search
{
  "size": 0,
  "aggs": {
    "500명단위customers": {
      "histogram": {
        "field": "customers",
        "interval": 500
      },
      "aggs": {
        "고객수 합": {
          "sum": {
            "field": "customers"
          }
        }
      }
    }
  }
}
GET bank/_mapping
# 월별로 구간을 나누어 검색해보세요.
GET bank/_search
{
  "size": 0,
  "aggs": {
    "월별구간": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1M",
        "format": "yyyy-MM"
      },
      "aggs":
      {"월별 고객수" : {
        "sum": {
          "field": "customers"
        }
      }
      }
    }
  }
}
  # 년도별로 구간을 나누어 검색해보세요.
  GET bank/_search
{
  "size": 0,
  "aggs": {
    "연도별구간": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "1y",
        "format": "yyyy"
      },
      "aggs":
      {"연도별 고객수" : {
        "sum": {
          "field": "customers"
        }
      }
      }
    }
  }
}

# 위치 "키워드" 문자열 별로 버킷을 나누어 집계해보세요
GET bank/_search
{
  "size": 0,
  "aggs": {
    "위치별 은행 개수": {
      "value_count": {
        "field": "location.keyword"
      }
    }
  }
}


  # 1) 각 은행별로 2) 개점년도로 집계 후 3) 고객 수를 하위 집계를 수행해보세요.
GET bank/_search
{
  "size": 0,
  "aggs": {
    "은행별 지점 개수": {
      "terms": {
        "field": "bank.keyword"
      },
      "aggs": {
        "개점년도별": {
          "date_histogram": {
            "field": "date",
            "calendar_interval": "1y",
            "format": "yyyy년"
          },
          "aggs": {
            "총 고객수": {
              "sum": {
                "field": "customers"
              }
            }
          }
        }
      }
    }
  }
}

  
#  1) 각 은행별로  2-1) 총 고객 수와  2-2)고객 수 평균을 모두 집계합니다.
GET bank/_search
{
  "size": 0,
  "aggs": {
    "은행별 지점 개수": {
      "terms": {
        "field": "bank.keyword"
      },
      "aggs": {
        "평균 고객 수": {
          "avg": {
            "field": "customers"
          }
        },
        "총 고객 수": {
          "sum": {
            "field": "customers"
          }
        }
      }
    }
  }
}

  
  
    GET bank/_search
  {
    "size": 0,
    "aggs": {
      "개점년도별 집계": {
        "date_histogram": {
          "field": "date",
          "calendar_interval": "1y",
          "format": "yyyy년도"
        },
        "aggs": {
          "연도별 은행 고객수": {
            "sum": {
              "field": "customers"
            }
          }
        }
      },
      "연간 은행 방문 고객수 총합이 가장 큰 년도": {
        "max_bucket": {
          "buckets_path": "개점년도별 집계>연도별 은행 고객수"
        }
      }
    }
  }
    